<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ä°nci&Mert Bildirim Sistemi ğŸ’Œ</title>
</head>
<body>
  <h1>ğŸ’˜ Bildirim Testi ğŸ’˜</h1>

  <button id="bildirimAc">ğŸ”” Bildirimleri AÃ§</button>
  <button id="bildirimGonder">ğŸ’Œ Bildirim GÃ¶nder</button>

  <script>
    const publicKey = "BI2BIfpkUDT96rP3-WVtRoSU7vuvoAqRs27aEOa9Ztv8j3hEpEpZXFYRo09qNeZY4t_HLWKna0fylWZAeLCbovA";
    const bildirimAcBtn = document.getElementById("bildirimAc");
    const bildirimGonderBtn = document.getElementById("bildirimGonder");

    // Service worker kaydÄ±
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js").then(() => {
        console.log("âœ… Service worker baÅŸarÄ±yla kaydedildi");
      });
    }

    // Base64 Public key'i Uint8'e Ã§evir
    function urlBase64ToUint8Array(base64String) {
      const padding = "=".repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/\-/g, "+").replace(/_/g, "/");
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    // Bildirim izni ve abone olma
    bildirimAcBtn.addEventListener("click", async () => {
      const izin = await Notification.requestPermission();
      if (izin !== "granted") {
        alert("Ä°zin verilmedi ğŸ˜¢");
        return;
      }

      const reg = await navigator.serviceWorker.ready;
      const abone = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(publicKey)
      });

      // Sunucuya abone gÃ¶nder
      await fetch("https://bildirim.repl.co/abone", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(abone)
      });

        await fetch("https://bildirim.repl.co/hata", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ hata: `ğŸ’¾ Abone kaydÄ± yollandÄ±: ${abone.endpoint}` })
  });

      alert("ğŸ›ï¸ Bildirimlere abone oldun!");
    });

    // Bildirim gÃ¶nderme
    bildirimGonderBtn.addEventListener("click", async () => {
      const mesaj = prompt("GÃ¶ndermek istediÄŸin bildirim mesajÄ±:");
      if (!mesaj) return;

      const res = await fetch("https://bildirim.repl.co/bildirim", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mesaj })
      });

      const data = await res.json();
      alert(data.message);
    });
  </script>
</body>
</html>
